# 2. I2C

* 近距离
* 低速
* 半双工
* I2C是一种多主机总线，连接在总线上的器件分为主机和从机
  * 主机有权发起和结束一次通信
  * 从机只能被主机呼叫
  * 多个主机同时启用总线时，可以冲突监测和仲裁来防止错误发生
* I2C有两根线
  * SCL（时钟）
  * SDA（数据）
* 总线上每一个设备都有唯一的地址，且每个设备都可以作为主机，也可以作为从机（但同一时间只有一个主机）
* I2C可以发送任意多个字节，因为发送器与接收器共用一个时钟信号

## I2C通信过程

![null (1)](https://picture-6736.oss-cn-qingdao.aliyuncs.com/1/2023/01/20/20230120-210055.png)

第一个信号：

![image-20230124111620801](C:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/image-20230124111620801.png)

主机发送第一个字节后，所有从机都将高7位与自己的地址对比，如果一样，则认为自己被主机呼叫。然后再拿出第8位，确定自己在通信中作为发送机还是接收机。

## 起始信号与终止信号

* SCL为高电平，SDA下降沿，则为起始信号
* SCL为高电平，SDA上升沿，则为终止信号

起始信号与终止信号都是主机发出的，起始信号之后总线处于占用状态，终止信号之后总线处于空闲状态。

![image-20230124111611730](https://picture-6736.oss-cn-qingdao.aliyuncs.com/1/2023/01/24/20230124-111615.png)

**空闲状态时，SDA始终为高电平；占用状态时，SDA的跳变只在SCL为低电平时发生**

## 字节传送与应答

IIC通信时每个字节长度为8位（固定），==先传送高位，再传送低位==，发送器发送完一个字节数据后接收器必须发送1位应答位来回应，及==1帧有9位==。

![image-20230124111654407](https://picture-6736.oss-cn-qingdao.aliyuncs.com/1/2023/01/24/20230124-111656.png)

## 同步信号

什么时候发送什么时候接收的问题

 SCL低电平时，发送器向总线上发送一位数据，当SCL跳变到高电平时，接收器从总线上读取这一位数据。当SCL为高电平时，要维持总线上数据维持稳定。

![image-20230124124942651](https://picture-6736.oss-cn-qingdao.aliyuncs.com/1/2023/01/24/20230124-124946.png)

**SCL低电平时SDA可以发生变化，SCL高电平时SDA不可以发生变化**

## 三种I2C时序

注：阴影部分表示数据由主机向从机传送，无阴影部分则表示数据由从机向主机传送；A表示应答， A非表示非应答，S表示起始信号，P表示终止信号。

* 主机向从机发送数据

  ![image-20230124130109257](https://picture-6736.oss-cn-qingdao.aliyuncs.com/1/2023/01/24/20230124-130111.png)

  * 主机发完最后一个字节数据，从机应答，主机发送终止信号
  * 主机未发完，但从机不应答，主机发送终止信号

* 从机向主机发送数据

  ![image-20230124130117440](https://picture-6736.oss-cn-qingdao.aliyuncs.com/1/2023/01/24/20230124-130119.png)

  * 从机发送一个字节数据，主机不应答（!A），从机停止发送，主机发送终止信号
  * 从机发送最后一个字节数据后，主机不再收到数据，主机发送终止信号

* 主机先向从机发送数据，从机再向主机发送数据

  ![image-20230124130153084](https://picture-6736.oss-cn-qingdao.aliyuncs.com/1/2023/01/24/20230124-130155.png)
  
  * I2C在一次通信中，数据传输方向是不能改变的，只能由第1个字节决定。若要改变数据传输方向，则只能是重启一个通信任务。
  * 发起第二次通信时，主机==不需要发送终止信号，直接发送起始信号==。这么做为了不释放总线，防止在两个通信任务之间，被其他主机的通信任务抢占总线。

# 3. SPI

* 高速
* 全双工
* 同步

* SPI采用主从方式工作，一般有一个主设备和多个从设备
* SPI至少需要4根线
  * MISO（主设备输入从设备输出）
  * MOSI（主设备输出从设备输出）
  * SCLK（时钟）
  * CS（片选）（随着从机数量增加，需要用到多个片选线）
* 主机管理总线，从机只能被主机呼叫，不能主动呼叫主机 